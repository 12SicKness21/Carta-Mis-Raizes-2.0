<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√≥digo QR | Mis Ra√≠zes</title>
    <link rel="stylesheet" href="/css/admin.css">
    <style>
        .qr-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 40px 20px;
            text-align: center;
        }

        .qr-page-logo {
            max-width: 200px;
            margin-bottom: 25px;
        }

        .qr-page-title {
            font-size: 1.5rem;
            color: var(--gold);
            margin-bottom: 10px;
        }

        .qr-page-sub {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 30px;
        }

        .qr-page-card {
            max-width: 400px;
            width: 100%;
            padding: 30px;
            background: #ffffff;
            border-radius: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(212, 168, 83, 0.15), 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 2px solid var(--gold);
        }

        .qr-canvas-container {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .qr-canvas-container canvas {
            width: 100%;
            max-width: 350px;
            height: auto;
            border-radius: 8px;
        }

        .qr-brand {
            margin-top: 15px;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            color: #1a1a1a;
            letter-spacing: 1px;
        }

        .qr-brand-sub {
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            color: #888;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-top: 4px;
        }

        .qr-page-url {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-bottom: 25px;
            word-break: break-all;
        }

        .qr-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        @media print {
            body {
                background: white !important;
            }

            .qr-page-title {
                color: #333 !important;
            }

            .qr-page-sub {
                color: #666 !important;
            }

            .qr-page-url,
            .qr-buttons,
            .qr-page-logo {
                display: none !important;
            }

            .qr-page-card {
                box-shadow: none !important;
                border: 2px solid #333 !important;
            }
        }
    </style>
</head>

<body>
    <div class="qr-page">
        <img src="/img/logo.jpg" alt="Mis Ra√≠zes" class="qr-page-logo">
        <h1 class="qr-page-title">Escanea para ver nuestra carta</h1>
        <p class="qr-page-sub">Mis Ra√≠zes ¬∑ Cocina Peruana</p>
        <div class="qr-page-card" id="qrCard">
            <div class="qr-canvas-container">
                <div class="spinner" style="margin: 40px auto;" id="qrSpinner"></div>
                <canvas id="qrCanvas" style="display:none;"></canvas>
            </div>
            <p class="qr-brand">MIS RA√çZES</p>
            <p class="qr-brand-sub">Cocina Peruana</p>
        </div>
        <p class="qr-page-url" id="qrUrl"></p>
        <div class="qr-buttons">
            <button class="btn btn-gold" onclick="window.print()">üñ®Ô∏è Imprimir</button>
            <button class="btn btn-outline" onclick="downloadQR()">üì∑ Descargar</button>
        </div>
    </div>
    <script>
        function renderQRWithLogo(qrDataUrl) {
            var canvas = document.getElementById('qrCanvas');
            var ctx = canvas.getContext('2d');
            var spinner = document.getElementById('qrSpinner');

            var qrImg = new Image();
            qrImg.onload = function () {
                var size = qrImg.width;
                canvas.width = size;
                canvas.height = size;

                // Draw QR code
                ctx.drawImage(qrImg, 0, 0, size, size);

                // Load and draw logo overlay
                var logo = new Image();
                logo.onload = function () {
                    var logoSize = size * 0.22;
                    var x = (size - logoSize) / 2;
                    var y = (size - logoSize) / 2;

                    // White circle background
                    ctx.beginPath();
                    ctx.arc(size / 2, size / 2, logoSize / 2 + 8, 0, Math.PI * 2);
                    ctx.fillStyle = '#ffffff';
                    ctx.fill();

                    // Gold ring
                    ctx.beginPath();
                    ctx.arc(size / 2, size / 2, logoSize / 2 + 4, 0, Math.PI * 2);
                    ctx.strokeStyle = '#d4a853';
                    ctx.lineWidth = 3;
                    ctx.stroke();

                    // Clip circle for logo
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(size / 2, size / 2, logoSize / 2, 0, Math.PI * 2);
                    ctx.clip();
                    ctx.drawImage(logo, x, y, logoSize, logoSize);
                    ctx.restore();

                    spinner.style.display = 'none';
                    canvas.style.display = 'block';
                };
                logo.onerror = function () {
                    // Show QR without logo if logo fails
                    spinner.style.display = 'none';
                    canvas.style.display = 'block';
                };
                logo.src = '/img/logo.jpg';
            };
            qrImg.src = qrDataUrl;
        }

        function downloadQR() {
            var canvas = document.getElementById('qrCanvas');
            var link = document.createElement('a');
            link.download = 'QR-mis-raizes.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        fetch('/api/qr')
            .then(function (r) { return r.json(); })
            .then(function (data) {
                renderQRWithLogo(data.qr);
                document.getElementById('qrUrl').textContent = data.url;
            })
            .catch(function () {
                document.getElementById('qrSpinner').style.display = 'none';
                document.getElementById('qrCanvas').parentElement.innerHTML = '<p style="color:#e74c3c;">Error al generar QR</p>';
            });
    </script>
</body>

</html>